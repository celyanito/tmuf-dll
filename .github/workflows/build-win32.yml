name: build-win32

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Locate solution
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Recurse -Filter *.sln | Select-Object -First 1
          if (-not $sln) { throw "No .sln found in repo." }
          "SLN=$($sln.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using solution: $($sln.FullName)"

      - name: Show solution configurations
        shell: pwsh
        run: |
          msbuild "$env:SLN" /t:ValidateSolutionConfiguration /v:m

      - name: Build (try Win32, fallback x86)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          try {
            msbuild "$env:SLN" /m /p:Configuration=Debug /p:Platform=Win32
            Write-Host "Built with Platform=Win32"
          } catch {
            Write-Host "Win32 failed, retrying with Platform=x86..."
            msbuild "$env:SLN" /m /p:Configuration=Debug /p:Platform=x86
            Write-Host "Built with Platform=x86"
          }

      - name: Upload artifact (DLL/PDB)
        uses: actions/upload-artifact@v4
        with:
          name: build-Debug-x86
          path: |
            **\Debug\*.dll
            **\Debug\*.pdb